/**
 * @fileoverview Firestore Security Rules for VedicVerse application.
 *
 * Core Philosophy:
 * This ruleset enforces a combination of ownership-based access control for user data and public read access with owner-only writes for product and launch schedule data.  Admin privileges are granted based on presence in a dedicated roles collection.
 *
 * Data Structure:
 * - /products/{productId}: Public product catalog.
 * - /launchSchedules/{launchScheduleId}: Public launch schedules.
 * - /users/{userId}: User profiles, accessible only by the user.
 * - /users/{userId}/orders/{orderId}: Orders placed by a specific user, accessible only by that user or an admin.
 * - /roles_admin/{userId}: Collection indicating admin status.
 *
 * Key Security Decisions:
 * - Products and LaunchSchedules are publicly readable, but only owners (if ownership field existed) could modify them. Since no ownership fields exist on these entities, only admins can create, update, or delete them.
 * - User listing is explicitly disallowed.
 * - Orders are strictly owned by the user who placed them, enforced through path-based rules.
 * - Admin privileges are determined by the existence of a document in the /roles_admin/{userId} collection.
 *
 * Denormalization for Authorization:
 * - The /users/{userId}/orders/{orderId} path inherently denormalizes the user-order relationship, enabling simple authorization checks without requiring additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided user ID.
     * @param {string} userId The user ID to compare against.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

     /**
      * @description Checks if the authenticated user is an admin.
      * @returns {boolean} True if the user is an admin, false otherwise.
      */
     function isAdmin() {
       return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
     }

     /**
      * @description Checks if the authenticated user is the owner of an existing document.
      * @param {string} userId The user ID to compare against.
      * @returns {boolean} True if the user is the owner and the document exists, false otherwise.
      */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for the /products collection. Allows public read access, and allows any signed-in user to create/edit/delete for now.
     * @path /products/{productId}
     * @allow (get, list): Any user can read product information.
     * @allow (create, update, delete): Any signed-in user can manage products.
     * @principle Public read access with authenticated writes.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Rules for the /launchSchedules collection. Allows public read access, but restricts writes to admins only since no ownership field is present on the LaunchSchedule entity.
     * @path /launchSchedules/{launchScheduleId}
     * @allow (get, list): Any user can read launch schedule information.
     * @allow (create): Only admins can create a launch schedule.
     * @deny (create): A non-admin user attempts to create a launch schedule.
     * @principle Public read access with admin-only writes due to missing ownership field.
     */
    match /launchSchedules/{launchScheduleId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Rules for the /users collection. Enforces strict user ownership for all operations.
     * @path /users/{userId}
     * @allow (get): The user can read their own profile.
     * @allow (create): The user can create their own profile if the userId matches their auth.uid.
     * @deny (create): A user attempts to create a profile with a userId that doesn't match their auth.uid.
     * @deny (update): A user attempts to update another user's profile.
     * @principle Enforces strict user ownership for all profile data.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/orders collection. Enforces user ownership of orders and allows admins access.
     * @path /users/{userId}/orders/{orderId}
     * @allow (get): The user can read their own order, or an admin can read any order.
     * @allow (create): The user can create an order for themselves if the userId matches their auth.uid.
     * @deny (create): A user attempts to create an order for another user.
     * @deny (update): A user attempts to update another user's order.
     * @principle Enforces strict user ownership for orders with admin override.
     */
    match /users/{userId}/orders/{orderId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if (isExistingOwner(userId) || isAdmin()) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId) || isAdmin();
    }

    /**
     * @description Rules for the /roles_admin collection. Only admins can create documents in this collection, effectively granting admin roles.
     * @path /roles_admin/{userId}
     * @allow (get): Any authenticated user can check if a user is an admin by attempting to read the document.
     * @allow (create): Only admins can grant admin roles.
     * @deny (create): A non-admin user attempts to grant admin roles.
     * @principle Restricts admin role assignment to existing admins.
     */
    match /roles_admin/{userId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if false;
      allow delete: if isAdmin();
    }
  }
}
